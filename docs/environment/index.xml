<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Drupal WxT â€“ Environment</title><link>https://drupalwxt.github.io/docs/environment/</link><description>Recent content in Environment on Drupal WxT</description><generator>Hugo -- gohugo.io</generator><language>en</language><atom:link href="https://drupalwxt.github.io/docs/environment/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: Containers</title><link>https://drupalwxt.github.io/docs/environment/containers/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://drupalwxt.github.io/docs/environment/containers/</guid><description>
&lt;p>For the (optional) container based development workflow this is roughly the steps that are followed.&lt;/p>
&lt;p>Clone the docker-scaffold repository:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>git clone https://github.com/drupalwxt/docker-scaffold.git docker
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>&lt;strong>Note&lt;/strong>: The &lt;code>docker&lt;/code> folder should be added to your &lt;code>.gitignore&lt;/code> file.&lt;/p>
&lt;/blockquote>
&lt;h2 id="linux-environments">Linux Environments&lt;/h2>
&lt;p>The following are the steps you should follow for a Linux based environment.&lt;/p>
&lt;p>Create the necessary symlinks:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>ln -s docker/docker-compose.base.yml docker-compose.base.yml
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ln -s docker/docker-compose.ci.yml docker-compose.ci.yml
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ln -sf docker/docker-compose.yml docker-compose.yml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Create and adjust the following Makefile:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>include .env
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>NAME :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>or &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>BASE_IMAGE&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>,&lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>BASE_IMAGE&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>,drupalwxt/site-wxt&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>VERSION :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>or &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>VERSION&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>,&lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>VERSION&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>,&lt;span style="color:#4e9a06">&amp;#39;latest&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>PLATFORM :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>shell uname -s&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>&lt;span style="color:#204a87">eval&lt;/span> GIT_USERNAME :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">$(if&lt;/span> &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>GIT_USERNAME&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>,&lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>GIT_USERNAME&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>,gitlab-ci-token&lt;span style="color:#204a87;font-weight:bold">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>&lt;span style="color:#204a87">eval&lt;/span> GIT_PASSWORD :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">$(if&lt;/span> &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>GIT_PASSWORD&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>,&lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>GIT_PASSWORD&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>,&lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>CI_JOB_TOKEN&lt;span style="color:#204a87;font-weight:bold">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>DOCKER_REPO :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> https://github.com/drupalwxt/docker-scaffold.git
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>GET_DOCKER :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>shell &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span> -d docker &lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">||&lt;/span> git clone &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>DOCKER_REPO&lt;span style="color:#204a87;font-weight:bold">)&lt;/span> docker&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>include docker/Makefile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Build and setup your environment with default content:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Composer install&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">COMPOSER_MEMORY_LIMIT&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>-1 &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> composer install
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Make our base docker image&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>make build
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Bring up the dev stack&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker compose -f docker-compose.yml build --no-cache
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker compose -f docker-compose.yml up -d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Install Drupal&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>make drupal_install
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Development configuration&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>./docker/bin/drush config-set system.performance js.preprocess &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> -y &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>./docker/bin/drush config-set system.performance css.preprocess &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> -y &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>./docker/bin/drush php-eval &lt;span style="color:#4e9a06">&amp;#39;node_access_rebuild();&amp;#39;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>./docker/bin/drush config-set wxt_library.settings wxt.theme theme-gcweb -y &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>./docker/bin/drush cr
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Migrate default content&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>./docker/bin/drush migrate:import --group wxt --tag &lt;span style="color:#4e9a06">&amp;#39;Core&amp;#39;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>./docker/bin/drush migrate:import --group gcweb --tag &lt;span style="color:#4e9a06">&amp;#39;Core&amp;#39;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>./docker/bin/drush migrate:import --group gcweb --tag &lt;span style="color:#4e9a06">&amp;#39;Menu&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="modern-osx-environments">Modern OSX Environments&lt;/h2>
&lt;p>If you have &lt;code>Docker for Desktop&lt;/code> and a new enough OSX environment (Monterey or higher) then the steps are the exact same as those for the Linux environment given above.&lt;/p>
&lt;p>All that is required in advance is to enable &lt;code>VirtioFS&lt;/code> accelerated directory sharing which you can see in the attached picture below.&lt;/p>
&lt;figure class="card rounded p-2 td-post-card mb-4 mt-4" style="max-width: 917px">
&lt;img class="card-img-top" src="../../docs/environment/containers/virtiofs_hua445c97bc04e8c98a3e33391a65ffc40_78771_0x300_resize_catmullrom_3.png" width="907" height="300">
&lt;figcaption class="card-body px-0 pt-2 pb-0">
&lt;p class="card-text">
Docker for Desktop VirtioFS
&lt;small class="text-muted">&lt;br/>Image: Drupal / CC-BY-CA&lt;/small>
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>For older environments you may still use mutagen which is discussed below.&lt;/p>
&lt;h2 id="legacy-osx-environments-mutagen">Legacy OSX Environments (Mutagen)&lt;/h2>
&lt;p>While this is fixed with the new virtualization framework discussed above.&lt;/p>
&lt;p>For older environments mutagen will have to be used instead and as such requires a few additional steps.&lt;/p>
&lt;ul>
&lt;li>&lt;strong>&lt;a href="https://github.com/docker/roadmap/issues/7">Improve Mac File system performance&lt;/a>&lt;/strong>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Mutagen Setup&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">VOLUME&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>site-wxt-mutagen-cache
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker volume create &lt;span style="color:#000">$VOLUME&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker container create --name &lt;span style="color:#000">$VOLUME&lt;/span> -v &lt;span style="color:#000">$VOLUME&lt;/span>:/volumes/&lt;span style="color:#000">$VOLUME&lt;/span> mutagenio/sidecar:0.13.0-beta3
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker start &lt;span style="color:#000">$VOLUME&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>mutagen sync create --name &lt;span style="color:#000">$VOLUME&lt;/span> --sync-mode&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>two-way-resolved --default-file-mode-beta &lt;span style="color:#0000cf;font-weight:bold">0666&lt;/span> --default-directory-mode-beta &lt;span style="color:#0000cf;font-weight:bold">0777&lt;/span> &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>&lt;span style="color:#204a87">pwd&lt;/span>&lt;span style="color:#204a87;font-weight:bold">)&lt;/span> docker://&lt;span style="color:#000">$VOLUME&lt;/span>/volumes/&lt;span style="color:#000">$VOLUME&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Create symlinks&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ln -s docker/docker-compose.mutagen.yml docker-compose.mutagen.yml
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Composer install&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">COMPOSER_MEMORY_LIMIT&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>-1 &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> composer install
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Make our base docker image&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>make build
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Bring up the dev stack&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker compose -f docker-compose.mutagen.yml build --no-cache
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker compose -f docker-compose.mutagen.yml up -d
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Install Drupal&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>make drupal_install
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Development configuration&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>./docker/bin/drush config-set system.performance js.preprocess &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> -y &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>./docker/bin/drush config-set system.performance css.preprocess &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> -y &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>./docker/bin/drush php-eval &lt;span style="color:#4e9a06">&amp;#39;node_access_rebuild();&amp;#39;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>./docker/bin/drush config-set wxt_library.settings wxt.theme theme-gcweb -y &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>./docker/bin/drush cr
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Migrate default content&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>./docker/bin/drush migrate:import --group wxt --tag &lt;span style="color:#4e9a06">&amp;#39;Core&amp;#39;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>./docker/bin/drush migrate:import --group gcweb --tag &lt;span style="color:#4e9a06">&amp;#39;Core&amp;#39;&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span>./docker/bin/drush migrate:import --group gcweb --tag &lt;span style="color:#4e9a06">&amp;#39;Menu&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="cleanup">Cleanup&lt;/h2>
&lt;p>If you wish to have a pristine docker environment you may execute the following commands.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>docker rm &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>docker ps -a -q&lt;span style="color:#204a87;font-weight:bold">)&lt;/span> --force
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker rmi &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>docker images -q&lt;span style="color:#204a87;font-weight:bold">)&lt;/span> --force
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker volume prune -f
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>For those still using Mutagen you may also need to execute the following command:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>mutagen sync terminate &amp;lt;sync_xxxxx&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;!-- Links Referenced --></description></item><item><title>Docs: Kubernetes</title><link>https://drupalwxt.github.io/docs/environment/kubernetes/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://drupalwxt.github.io/docs/environment/kubernetes/</guid><description>
&lt;p>&lt;img src="architecture.svg" alt="Cloud Native Architecture">&lt;/p>
&lt;h2 id="introduction">Introduction&lt;/h2>
&lt;ul>
&lt;li>&lt;strong>&lt;a href="https://github.com/drupalwxt/helm-drupal/blob/master/docs/diagram-drupal.pdf">Architectural Diagram&lt;/a>&lt;/strong>&lt;/li>
&lt;li>&lt;strong>&lt;a href="https://github.com/drupalwxt/helm-drupal">Helm Chart for Drupal WxT&lt;/a>&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>This document represents a high-level technical overview of how the &lt;strong>&lt;a href="https://github.com/drupalwxt/helm-drupal">Helm Chart for Drupal WxT&lt;/a>&lt;/strong> was built and how we envision &lt;strong>&lt;a href="https://github.com/drupalwxt/wxt">Drupal&lt;/a>&lt;/strong> itself should be architected in the cloud to support any of the Government of Canada procured cloud service providers (&lt;code>AWS&lt;/code>, &lt;code>Azure&lt;/code>, and &lt;code>GCP&lt;/code>). It should be noted that this Helm chart would also work in an on-premise environment with the appropriate Kubernetes infrastructure.&lt;/p>
&lt;p>A key mandate when creating this architecture was to follow the Open Source Directive as given by the Treasury Board Secretariat (C.2.3.8) which states that you should try to use open standards and open source software first. Additionally, where possible all functionality should be exposed as restful services and leverage microservices via a containerized approach (C2.3.10).&lt;/p>
&lt;p>We are leveraging a microservices design pattern utilizing immutable and scanned images through containerization running on Kubernetes with a platform that has been built and open sourced by Statistics Canada. While the platform will be discussed briefly to provide context the bulk of the document discusses how Drupal is installed and configured on top of it.&lt;/p>
&lt;h2 id="kubernetes">Kubernetes&lt;/h2>
&lt;div class="alert alert-info" role="alert">
The base of the platform - Kubernetes is the first graduate of the &lt;strong>&lt;a href="https://www.cncf.io">CNCF&lt;/a>&lt;/strong> (Cloud Native Computing Foundation).
&lt;/div>
&lt;p>&lt;strong>&lt;a href="https://kubernetes.io">Kubernetes&lt;/a>&lt;/strong> orchestrates the computing, networking, and storage infrastructure on behalf of user workloads. It assigns workloads and resources to a series of nearly identically-configured virtual machines.&lt;/p>
&lt;p>Kukbernetes supports workloads running anywhere, from IoT devices, to private cloud and all the way to public cloud. This is possible due to Kubernetes&amp;rsquo; pluggable architecture, which defines interfaces that are then implemented for the different environments. Kubernetes provides an Infrastructure as Code environment defined through declarative configuration. Because Kubernetes abstracts away the implementation of the computing environment, application dependencies such as storage, networking, etc., applications do not have to concern themselves with these differences.&lt;/p>
&lt;p>Kubernetes is backed by a huge (10,000+) and vibrant growing community, consisting of end users, business, vendors and large cloud providers.&lt;/p>
&lt;h3 id="key-points">Key Points&lt;/h3>
&lt;p>This architecture brings many benefits to the Government of Canada:&lt;/p>
&lt;ul>
&lt;li>Support for hybrid workloads (Linux and Windows), deployed using the same methodology&lt;/li>
&lt;li>Abstraction of underlying hardware (&amp;ldquo;cattle rather than pets&amp;rdquo;) enabling an automated, highly-available and scaleable infrastructure for microservices&lt;/li>
&lt;li>Declarative configuration enabling Infrastructure as Code allowing for deployment automation, reproducibility and re-use&lt;/li>
&lt;li>Constructs to support advanced deployment patterns (blue/green, canary, etc.) enabling zero-downtime deployments&lt;/li>
&lt;li>Platform-level tooling for traffic handling (routing, error recovery, encyption, etc.), monitoring, observability and logging, and secrets management&lt;/li>
&lt;/ul>
&lt;p>Kubernetes is supported across all cloud service providers (fully managed and self managed), preventing vendor lock-in. Managed offerings are available from Google, IBM, Azure, Digital Ocean, Amazon, Oracle and more. The choice whether to roll your own, using a managed service (AKS, EKS, GKE) or a Platform as a Service (OpenShift, Pivotal) is up to the organization to decide based on their requirements and risks. Our preference is to stay as close as possible to the open source version of Kubernetes as well as tooling in order to remain compatible with the different Kubernetes offerings (raw, managed, platform, etc.).&lt;/p>
&lt;h2 id="government">Government&lt;/h2>
&lt;p>Kubernetes is being actively investigated and/or used by many departments across the Government of Canada. Departments are starting to collaborate more and work together towards a common, well-vetted solution and this is why we have have Open Sourced our platform on the GC Accelerators hoping to foster this collaboration and form a community of practice.&lt;/p>
&lt;p>Provided below is the Terraform (Infrastructure as Code) necessarily to install the Azure Kubernetes Service Infrastructure as well as configure with optional platform components (RBAC, Service Mesh, Policies, etc).&lt;/p>
&lt;ul>
&lt;li>&lt;strong>&lt;a href="https://github.com/canada-ca-terraform-modules/terraform-kubernetes-aks">Terraform for Kubernetes Infrastructure&lt;/a>&lt;/strong>&lt;/li>
&lt;li>&lt;strong>&lt;a href="https://github.com/canada-ca-terraform-modules/terraform-kubernetes-aks-platform">Terraform for Kubernetes Platform&lt;/a>&lt;/strong>&lt;/li>
&lt;/ul>
&lt;h2 id="drupal-wxt-on-kubernetes">Drupal WxT on Kubernetes&lt;/h2>
&lt;p>A managed Drupal Platform as a Service is a strong candidate to take advantage of what a Kubernetes platform offers. The design enables a quick onboarding of new workloads through the repeatable deployment methodology provided by Kubernetes.&lt;/p>
&lt;h3 id="kubernetes-1">Kubernetes&lt;/h3>
&lt;p>&lt;strong>Recommendation:&lt;/strong> &lt;strong>&lt;a href="https://kubernetes.io">Kubernetes&lt;/a>&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;strong>&lt;a href="https://github.com/drupalwxt/helm-drupal">Helm Chart for Drupal WxT&lt;/a>&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>Kubernetes is the basis of the Drupal platform and was further discussed above.&lt;/p>
&lt;p>The whole Drupal application stack can be easily installed in a distributed fashion in minutes using our Helm chart, The chart facilitates a managed service workflow (rolling updates, cronjobs, health checks, auto-scaling, etc.) without user intervention.&lt;/p>
&lt;h3 id="ingress-controller">Ingress controller&lt;/h3>
&lt;p>&lt;strong>Recommendation:&lt;/strong> &lt;strong>&lt;a href="https://istio.io/docs/tasks/traffic-management/ingress/ingress-control">Istio&lt;/a>&lt;/strong>&lt;/p>
&lt;p>The ingress controller is responsible for accepting external HTTPS connections and routing them to backend applications based on configuration defined in Kubernetes Ingress objects. Routing can be done by domain and/or path.&lt;/p>
&lt;h3 id="varnish">Varnish&lt;/h3>
&lt;p>&lt;strong>Recommendation:&lt;/strong> &lt;strong>&lt;a href="https://varnish-cache.org">Varnish&lt;/a>&lt;/strong>&lt;/p>
&lt;p>Varnish is a highly customizable reverse proxy cache. This will aid in supporting a large number of concurrent visitors as the final rendered pages can be served from cache. Varnish is only required on the public environment and is not used in the content staging environment.&lt;/p>
&lt;p>Nginx can technically address some of the cache requirements needed, however the open source version does not support purging selective pages. We need to clear caches based on content being updated / saved which Varnish supports along with the Expire Drupal module quite readily&lt;/p>
&lt;h3 id="nginx">Nginx&lt;/h3>
&lt;p>&lt;strong>Recommendation:&lt;/strong> &lt;strong>&lt;a href="https://www.nginx.com">Nginx&lt;/a>&lt;/strong>&lt;/p>
&lt;p>Nginx is an open source web server that can also be used a reverse proxy, HTTP cache, and load balancer. Due to its root in performance optimization under scale, Nginx often outperforms similarly popular web servers and is built to offer low memory usage, and high concurrency.&lt;/p>
&lt;h3 id="web-php-fpm">Web (PHP-FPM)&lt;/h3>
&lt;p>&lt;strong>Recommendation:&lt;/strong> &lt;strong>&lt;a href="https://php-fpm.org">PHP-FPM&lt;/a>&lt;/strong>&lt;/p>
&lt;p>Drupal runs in the PHP runtime environment. PHP-FPM is the process manager organized as a master process managing pools of individual worker processes. Its architecture shares design similarities with event-driven web servers such as Nginx and allows for PHP scripts to use as much of the server's available resources as necessary without additional overhead that comes from running them inside of web server processes.&lt;/p>
&lt;p>The PHP-FPM master process dynamically creates and terminates worker processes (within configurable limits) as traffic to PHP scripts increases and decreases. Processing scripts in this way allows for much higher processing performance, improved security, and better stability. The primary performance benefits from using PHP-FPM are more efficient PHP handling and ability to use opcode caching.&lt;/p>
&lt;h3 id="redis">Redis&lt;/h3>
&lt;p>&lt;strong>Recommendation:&lt;/strong> &lt;strong>&lt;a href="https://redis.io">Redis&lt;/a>&lt;/strong>&lt;/p>
&lt;p>Redis is an advanced key-value cache and store.&lt;/p>
&lt;p>It is often referred to as a data structure server since keys can contain strings, hashes, lists, sets, sorted sets, bitmaps, etc.&lt;/p>
&lt;p>Redis is particularly useful when using cloud managed databases to limit the overall database load and to make performance more consistent.&lt;/p>
&lt;h3 id="database">Database&lt;/h3>
&lt;p>&lt;strong>Recommendation:&lt;/strong> &lt;strong>&lt;a href="https://www.mysql.com">MySQL&lt;/a>&lt;/strong> or &lt;strong>&lt;a href="https://www.postgresql.org">PostgreSQL&lt;/a>&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;strong>&lt;a href="https://github.com/canada-ca-terraform-modules/terraform-azurerm-mysql">Terraform for MySQL Database&lt;/a>&lt;/strong>&lt;/li>
&lt;li>&lt;strong>&lt;a href="https://github.com/canada-ca-terraform-modules/terraform-azurerm-postgresql">Terraform for PostgreSQL Database&lt;/a>&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>Drupal maintains its state in a database and while supports several types only MySQL or PostgreSQL should be considered. Personally, we highly recommend PostgreSQL based on the experience we had building / launching quite a few Drupal sites in the cloud with it. However both run quite well with minimal operational concerns. Additionally the Helm Chart supports connection pooling using either &lt;strong>&lt;a href="https://proxysql.com">ProxySQL&lt;/a>&lt;/strong> and / or &lt;strong>&lt;a href="https://www.pgbouncer.org">PGBouncer&lt;/a>&lt;/strong> depending on the database used.&lt;/p>
&lt;ul>
&lt;li>&lt;strong>&lt;a href="https://proxysql.com">ProxySQL&lt;/a>&lt;/strong>&lt;/li>
&lt;li>&lt;strong>&lt;a href="https://www.pgbouncer.org">PGBouncer&lt;/a>&lt;/strong>&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>&lt;strong>Note&lt;/strong>: Our recommendation would be to use a managed database offering from the cloud providers for a production environment. Coupled with a managed file service, this removes all stateful components from the cluster enabling the best application experience possible.&lt;/p>
&lt;/blockquote>
&lt;h3 id="stateful-assets">Stateful Assets&lt;/h3>
&lt;p>Drupal stores generated CSS/JS assets and uploaded content (images, videos, etc.) in a file storage. As the architecture is designed to be distributed, this present some design considerations for us.&lt;/p>
&lt;h4 id="azure-files-cifs--nfs">Azure Files (CIFS / NFS)&lt;/h4>
&lt;p>Fully managed file shares in the cloud that are accessible via Server Message Block (SMB) or NFS protocol. Support is provided for dynamically creating and using a persistent volume with Azure Files in the Azure Kubernetes Service.&lt;/p>
&lt;p>For more information on &lt;strong>&lt;a href="https://azure.microsoft.com/en-us/services/storage/files/#overview">Azure Files&lt;/a>&lt;/strong>, please see &lt;strong>&lt;a href="https://docs.microsoft.com/en-us/azure/aks/azure-files-dynamic-pv">Azure Files and AKS&lt;/a>.&lt;/strong>&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Note&lt;/strong>: This is currently our recommended choice as it results in a simpler installation in Azure then relying on an S3 compatible object store discussed below. Similar storage solutions exist with the other cloud providers.&lt;/p>
&lt;/blockquote>
&lt;!-- Links Referenced --></description></item><item><title>Docs: Azure App Service</title><link>https://drupalwxt.github.io/docs/environment/appsvc/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://drupalwxt.github.io/docs/environment/appsvc/</guid><description>
&lt;p>This page provides an overview for the process of creating a monolith container to deploy to Azure App Service (appsvc). It assumes you already have your project setup to work with the docker-scaffold repository. For initial project setup using docker-scaffold, see the beginning of the container based development workflow here - &lt;strong>&lt;a href="https://drupalwxt.github.io/docs/environment/containers">Local Docker setup&lt;/a>&lt;/strong>&lt;/p>
&lt;h2 id="build-the-appsvc-image">Build the appsvc image&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Make our base docker image&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>make build
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># Build the appsvc image&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker compose -f docker-compose.appsvc.yml up -d
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>&lt;strong>Note&lt;/strong>: After making changes to the project, you will need to remove your base image and build it again. This will ensure all changed files are copied into the base image as needed.&lt;/p>
&lt;/blockquote>
&lt;h3 id="delete-all-docker-images">Delete all Docker images&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>docker rmi &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>docker images -q&lt;span style="color:#204a87;font-weight:bold">)&lt;/span> --force
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="tag-appsvc-image-and-push-to-azure-container-registry-acr">Tag appsvc image and push to Azure Container Registry (ACR)&lt;/h2>
&lt;p>Now that you have build your appsvc image, you need to tag and push it to the ACR in order to deploy to it App Service.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>docker login MY-CONTAINER-REGISTRY.azurecr.io
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker tag site-XYZ-appsvc:latest MY-CONTAINER-REGISTRY.azurecr.io/site-XYZ-appsvc:&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>tag&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>docker push MY-CONTAINER-REGISTRY.azurecr.io/site-XYZ-appsvc:&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>tag&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Once this is done, you should be able to see your new image in the ACR.&lt;/p>
&lt;h2 id="build-pipeline">Build pipeline&lt;/h2>
&lt;p>In order to automate the build process using Azure DevOps, you can create a pipeline file in the root of your Drupal repo - &lt;strong>&lt;a href="https://gist.github.com/smulvih2/f473295594fe71d117ebc041f6e4b7ef">Example pipeline file&lt;/a>&lt;/strong>&lt;/p>
&lt;p>This pipeline script will build the appsvc image and push it to your container registry. Make sure you have cretaed the required Service Connection in Azure DevOps (Git repository, ACR).&lt;/p>
&lt;h2 id="notes">Notes&lt;/h2>
&lt;ul>
&lt;li>By default, the appsvc image comes with Varnish and Redis. This can cause issues if your App Service environment is set to Scale Out. This is because Varnish and Redis store cached data in memory, that cannot be mapped to a storage account or another shared resource. This can cause your instances to have different data, and users can see content flip between old and new versions when they refresh their borwser. It is recommended to stay with one instance when using the appsvc cotainer as it comes configured.&lt;/li>
&lt;/ul>
&lt;!-- Links Referenced --></description></item></channel></rss>